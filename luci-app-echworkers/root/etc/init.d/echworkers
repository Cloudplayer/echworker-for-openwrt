#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

PROG=/usr/bin/ech-workers
CONFIG=echworkers
NFT_TABLE=echworkers

# 设置 nftables 透明代理规则（直接重定向到 TPROXY 端口）
setup_nftables() {
	local tproxy_port="$1"
	local server_ip="$2"
	
	# 清理旧规则
	nft delete table inet $NFT_TABLE 2>/dev/null
	
	# 创建新表和链
	nft add table inet $NFT_TABLE
	nft add chain inet $NFT_TABLE prerouting { type nat hook prerouting priority -100 \; }
	
	# === IPv4 规则 ===
	# 排除本地地址、私有地址
	nft add rule inet $NFT_TABLE prerouting ip daddr 127.0.0.0/8 return
	nft add rule inet $NFT_TABLE prerouting ip daddr 10.0.0.0/8 return
	nft add rule inet $NFT_TABLE prerouting ip daddr 172.16.0.0/12 return
	nft add rule inet $NFT_TABLE prerouting ip daddr 192.168.0.0/16 return
	nft add rule inet $NFT_TABLE prerouting ip daddr 224.0.0.0/4 return
	nft add rule inet $NFT_TABLE prerouting ip daddr 240.0.0.0/4 return
	
	# 排除代理服务器 IP
	if [ -n "$server_ip" ]; then
		local resolved_ip=$(echo "$server_ip" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$')
		if [ -z "$resolved_ip" ]; then
			resolved_ip=$(nslookup "$server_ip" 2>/dev/null | grep -A1 'Name:' | grep 'Address' | head -1 | awk '{print $2}')
		fi
		[ -n "$resolved_ip" ] && nft add rule inet $NFT_TABLE prerouting ip daddr "$resolved_ip" return
	fi
	
	# 重定向来自 LAN 的 IPv4 HTTP/HTTPS 流量到 TPROXY 端口
	nft add rule inet $NFT_TABLE prerouting iifname "br-lan" ip version 4 tcp dport 80 redirect to :$tproxy_port
	nft add rule inet $NFT_TABLE prerouting iifname "br-lan" ip version 4 tcp dport 443 redirect to :$tproxy_port
	
	# === IPv6 规则 ===
	# 排除 IPv6 本地地址
	nft add rule inet $NFT_TABLE prerouting ip6 daddr ::1/128 return
	nft add rule inet $NFT_TABLE prerouting ip6 daddr fe80::/10 return
	nft add rule inet $NFT_TABLE prerouting ip6 daddr fc00::/7 return
	nft add rule inet $NFT_TABLE prerouting ip6 daddr ff00::/8 return
	
	# 暂时阻止 IPv6 的 HTTP/HTTPS（因为 TPROXY 暂不支持 IPv6）
	# 这会强制客户端回退到 IPv4
	nft add rule inet $NFT_TABLE prerouting iifname "br-lan" ip6 version 6 tcp dport 80 drop
	nft add rule inet $NFT_TABLE prerouting iifname "br-lan" ip6 version 6 tcp dport 443 drop
	
	logger -t echworkers "nftables TPROXY rules applied (port: $tproxy_port, IPv6 blocked)"
}

# 清理 nftables 规则
cleanup_nftables() {
	nft delete table inet $NFT_TABLE 2>/dev/null
	logger -t echworkers "nftables rules removed"
}

start_service() {
	config_load "$CONFIG"
	
	local enabled server listen token ip dns ech routing transparent tproxy_port
	config_get enabled config enabled 0
	config_get server config server
	config_get listen config listen "127.0.0.1:30001"
	config_get token config token
	config_get ip config ip
	config_get dns config dns
	config_get ech config ech
	config_get routing config routing "bypass_cn"
	config_get transparent config transparent 0
	config_get tproxy_port config tproxy_port 12345
	
	[ "$enabled" = "1" ] || return 0
	[ -n "$server" ] || return 1
	[ -x "$PROG" ] || {
		logger -t echworkers "ech-workers binary not found at $PROG"
		return 1
	}
	
	# 构建命令参数
	local args="-f $server -l $listen"
	[ -n "$token" ] && args="$args -token $token"
	[ -n "$ip" ] && args="$args -ip $ip"
	[ -n "$dns" ] && args="$args -dns $dns"
	[ -n "$ech" ] && args="$args -ech $ech"
	[ -n "$routing" ] && args="$args -routing $routing"
	
	# 透明代理模式：添加 TPROXY 参数
	if [ "$transparent" = "1" ]; then
		args="$args -tproxy 0.0.0.0:$tproxy_port"
	fi
	
	# 启动 ech-workers
	procd_open_instance echworkers
	procd_set_param command /bin/sh -c "cd /usr/share/ech-workers && exec $PROG $args"
	procd_set_param respawn
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param file /etc/config/echworkers
	procd_close_instance
	
	# 透明代理模式：设置 nftables 规则
	if [ "$transparent" = "1" ]; then
		# 等待服务启动
		sleep 1
		
		# 解析服务器 IP（用于排除规则）
		local server_ip_resolved=""
		if [ -n "$ip" ]; then
			server_ip_resolved="$ip"
		else
			local server_host=$(echo "$server" | cut -d: -f1)
			server_ip_resolved=$(nslookup "$server_host" 2>/dev/null | grep -A1 'Name:' | grep 'Address' | head -1 | awk '{print $2}')
		fi
		
		setup_nftables "$tproxy_port" "$server_ip_resolved"
	fi
}

stop_service() {
	cleanup_nftables
}

service_triggers() {
	procd_add_reload_trigger "$CONFIG"
}

reload_service() {
	stop
	start
}
